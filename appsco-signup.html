<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../neon-animation/neon-animated-pages.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">

<link rel="import" href="appsco-login-form.html">
<link rel="import" href="appsco-login-2fa.html">
<link rel="import" href="appsco-login-accounts.html">
<link rel="import" href="appsco-login-account-login.html">
<link rel="import" href="appsco-signup-form.html">

<!--
`appsco-signup`
Signup component is used to represent authentication methods to the user and provide signup process.

@demo demo/index.html 
-->

<dom-module id="appsco-signup">
    <template>
        <style>
            :host {
                display: block;
            }
            :host neon-animated-pages {
                min-height: 550px;
                overflow: hidden;
            }
            :host .login-page {
                padding: 4px;
            }
            .mt-30 {
                margin-top: 30px;
            }
            .mt-50 {
                margin-top: 50px;
            }
            .mb-20 {
                margin-bottom: 20px;
            }
            .text-center {
                text-align: center;
            }
        </style>

        <neon-animated-pages class="flex"
                             selected="{{ _selected }}"
                             attr-for-selected="name"
                             on-neon-animation-finish="_onNeonAnimationFinish">

            <appsco-login-form
                    name="appsco-login-form"
                    class="login-page"
                    on-iron-form-response="_onAppscoLoginFormResponse"
                    on-iron-form-error="_onAppscoLoginFormResponse">

                <div header></div>

                <div footer>
                    <div class="mt-50 text-center">
                        Don't have account?
                        <paper-button class="link primary" on-tap="_showSignupForm">Sign up</paper-button>
                    </div>
                </div>

            </appsco-login-form>

            <appsco-login-2fa
                    name="appsco-login-2fa"
                    class="login-page">

                <div header></div>

                <div footer>
                    <div class="text-center mt-50">
                        Back to
                        <paper-button class="link primary" on-tap="_showLoginPage">Login</paper-button>
                    </div>
                </div>

            </appsco-login-2fa>

            <appsco-login-accounts
                    name="appsco-login-accounts"
                    class="login-page"
                    selected-account="{{ _selectedAccount }}"
                    on-add-account="_showLoginForm"
                    on-storage-empty="_showLoginForm"
                    on-account-login="_showAccountLoginForm">

                <div header></div>

                <div footer>
                    <div class="text-center mt-50">
                        Want to create another account?
                        <paper-button class="link primary" on-tap="_showSignupForm">Sign up</paper-button>
                    </div>
                </div>

            </appsco-login-accounts>

            <appsco-login-account-login
                    name="appsco-login-account-login"
                    class="login-page"
                    account="[[ _selectedAccount ]]"
                    on-account-login-cancel="_showLoginPage">

                <div header></div>

                <div footer></div>

            </appsco-login-account-login>

            <appsco-signup-form
                    name="appsco-signup-form"
                    class="login-page">

                <div header></div>

                <div footer>
                    <div class="mt-50 text-center">
                        By registering, you agree to the
                        <a href="#">privacy policy</a> and
                        <a href="#">terms of service</a>.
                        Just enter your e-mail and password and start using
                        Appsco for free, no need for e-mail confirmation.
                    </div>

                    <div class="additional-info-section text-center mt-50">
                        Already have account?
                        <paper-button class="link primary" on-tap="_showLoginPage">Login</paper-button>
                    </div>
                </div>

            </appsco-signup-form>

            <!--<appsco-login-form-->
                    <!--id="appscoLoginForm"-->
                    <!--name="login-form"-->
                    <!--method="get"-->
                    <!--action="http://appsco.loc/app_dev.php/api/v2/me"-->
                    <!--title="Login"-->
                    <!--action-name="Login"-->
                    <!--remember-me="{{ _rememberMe }}"-->
                    <!--facebook-login="/facebook"-->
                    <!--google-login="/google"-->
                    <!--on-show-reset-password-form="__showResetPasswordForm"-->
                    <!--on-iron-form-error="__handleLoginFormResponse"-->
                    <!--on-iron-form-response="__handleLoginFormResponse">-->

                <!--<div class="content-info"></div>-->

                <!--<div class="content-additional-info">-->
                    <!--<div class="additional-info-section text-center mt-50">-->
                        <!--<template is="dom-if" if="[[ _hasAccounts ]]">-->
                            <!--<paper-button class="link primary" on-tap="__backToAccounts">Back</paper-button>-->
                            <!--to accounts-->
                        <!--</template>-->

                        <!--<template is="dom-if" if="[[ !_hasAccounts ]]">-->
                            <!--Don't have account?-->
                            <!--<paper-button class="link primary" on-tap="__showSignupForm">Sign up</paper-button>-->
                        <!--</template>-->
                    <!--</div>-->
                <!--</div>-->

            <!--</appsco-login-form>-->

            <!--<appsco-accounts-->
                    <!--id="accounts"-->
                    <!--name="account-list"-->
                    <!--title="Your accounts"-->
                    <!--accounts="[[ accounts ]]"-->
                    <!--remove-account="[[ _removeAccount ]]"-->
                    <!--on-account-chosen="__showAccountLogin"-->
                    <!--on-remove-account="__removeAccountFromLocaleStorage"-->
                    <!--on-tap="__handleAccountsTap">-->

                <!--<div class="actions layout horizontal">-->
                    <!--<paper-button class="flex account btn-primary"-->
                                  <!--on-tap="__addNewAccount">-->
                        <!--Add account-->
                    <!--</paper-button>-->

                    <!--<paper-button-->
                            <!--id="actionRemoveAccount"-->
                            <!--class="flex account btn-danger"-->
                            <!--on-tap="__accountRemoval"-->
                            <!--toggles>-->
                        <!--Remove account-->
                    <!--</paper-button>-->
                <!--</div>-->

                <!--<div class="additional-info-section text-center mt-50">-->
                    <!--Want to create another account?-->
                    <!--<paper-button class="link primary" on-tap="__showSignupForm">Sign up</paper-button>-->
                <!--</div>-->
            <!--</appsco-accounts>-->

            <!--<appsco-account-login-->
                    <!--name="account-login"-->
                    <!--method="post"-->
                    <!--action="/account-login"-->
                    <!--title="Account login"-->
                    <!--action-name="Login"-->
                    <!--account="{{ _selectedAccount }}"-->
                    <!--on-account-login-cancel="__cancelAccountLoginForm"-->
                    <!--on-iron-form-error="__handleAccountLoginFormResponse"-->
                    <!--on-iron-form-response="__handleAccountLoginFormResponse">-->
            <!--</appsco-account-login>-->

            <!--<appsco-two-factor-auth-form-->
                    <!--id="appscoTwoFactorAuthForm"-->
                    <!--name="two-factor-auth-form"-->
                    <!--method="post"-->
                    <!--action="/two-factor-authentication"-->
                    <!--title="Two-factor Authentication"-->
                    <!--action-name="Submit"-->
                    <!--on-iron-form-response="__handleTwoFactorAuthFormResponse">-->

                <!--<div class="content-info"></div>-->

                <!--<div class="content-additional-info additional-info-section text-center mt-50">-->
                    <!--Back to-->
                    <!--<paper-button class="link primary" on-tap="__resolveLogin">Login</paper-button>-->
                <!--</div>-->

            <!--</appsco-two-factor-auth-form>-->

            <!--<appsco-signup-form-->
                    <!--name="signup-form"-->
                    <!--method="post"-->
                    <!--action="/signup"-->
                    <!--title="Signup for free"-->
                    <!--action-name="Sign up"-->
                    <!--on-iron-form-response="__handleSignupFormResponse">-->

                <!--<div class="content-info"></div>-->

                <!--<div class="content-additional-info">-->
                    <!--<div class="mt-30">-->
                        <!--By registering, you agree to the-->
                        <!--<a href="#">privacy policy</a> and-->
                        <!--<a href="#">terms of service</a>.-->
                        <!--Just enter your e-mail and password and start using-->
                        <!--Appsco for free, no need for e-mail confirmation.-->
                    <!--</div>-->

                    <!--<div class="additional-info-section text-center mt-50">-->
                        <!--Already have account?-->
                        <!--<paper-button class="link primary" on-tap="__resolveLogin">Login</paper-button>-->
                    <!--</div>-->
                <!--</div>-->

            <!--</appsco-signup-form>-->

            <!--<appsco-reset-password-form-->
                    <!--name="reset-password-form"-->
                    <!--method="post"-->
                    <!--action="/reset-password"-->
                    <!--title="Reset Password"-->
                    <!--action-name="Reset"-->
                    <!--on-iron-form-response="__handleResetPasswordFormResponse">-->

                <!--<div class="content-info">-->
                    <!--Enter your email address and we'll send you a mail message with password reset link.-->
                <!--</div>-->

                <!--<div class="content-additional-info additional-info-section text-center mt-50">-->
                    <!--Back to-->
                    <!--<paper-button class="link primary" on-tap="__resolveLogin">Login</paper-button>-->
                <!--</div>-->

            <!--</appsco-reset-password-form>-->

        </neon-animated-pages>

        <iron-localstorage
                id="localStorageAccounts"
                name="appsco-accounts"
                value="{{ _accounts }}">
        </iron-localstorage>

    </template>

    <script>
        Polymer({

            is: 'appsco-signup',

            properties: {

                /**
                 * Selected signup component.
                 * It has value of component's 'name' attribute.
                 */
                _selected: {
                    type: String
                },

                /**
                 * Accounts from local storage.
                 */
                _accounts: {
                    type: Array
                },

                /**
                 * Selected account.
                 */
                _selectedAccount: {
                    type: Object
                }
            },

            attached: function() {
                this._showLoginPage();
            },

            /**
             * It sets selected page to Appsco Login Form.
             *
             * @private
             */
            _showLoginPage: function() {

                this.$.localStorageAccounts.reload();

                if (this._accounts && this._accounts.length > 0) {
                    this._showLoginAccounts();
                }
                else {
                    this._showLoginForm();
                }

            },

            /**
             * It sets selected page to Appsco Login Form.
             *
             * @private
             */
            _showLoginForm: function() {
                this._selected = 'appsco-login-form';
            },

            /**
             * It sets selected page to Appsco Login Two-factor Authentication form.
             *
             * @private
             */
            _showLogin2fa: function() {
                this._selected = 'appsco-login-2fa';
            },

            /**
             * It sets selected page to Appsco Login Form.
             *
             * @private
             */
            _showLoginAccounts: function() {
                this._selected = 'appsco-login-accounts';
            },

            /**
             * It sets selected page to Appsco Account Login Form.
             *
             * @private
             */
            _showAccountLoginForm: function() {
                this._selected = 'appsco-login-account-login';
            },

            /**
             * It sets selected page to Appsco Signup Form.
             *
             * @private
             */
            _showSignupForm: function() {
                this._selected = 'appsco-signup-form';
            },

            /**
             * Resets the previous visible form.
             * @param {HTMLElement} fromPage
             *
             * @private
             */
            _resetForm: function(fromPage) {
                var form = fromPage.querySelector('form');

                if (form) {
                    form.reset();
                }

                // Remove error from form.
                if (fromPage._error) {
                    fromPage._error = '';
                }
            },

            /**
             * Focuses first input field inside form.
             * @param {HTMLElement} toPage
             *
             * @private
             */
            _focusInputField: function(toPage) {
                var inputToFocus = toPage.querySelector('[auto-focus]');

                if (inputToFocus) {
                    inputToFocus.focus();
                }
            },

            /**
             * Called after page animation is finished.
             * @param {Object} event
             *
             * @private
             */
            _onNeonAnimationFinish: function(event) {
                this._resetForm(event.detail.fromPage);
                this._focusInputField(event.detail.toPage);
            },

            /**
             * Called after Appsco Login Form returns success with response.
             * @param {Object} event
             *
             * @private
             */
            _onAppscoLoginFormResponse: function(event) {

//                if (event.detail.response.twoFactorenabled) {
//                    this._showLogin2fa();
//                }

                this._showLogin2fa();

            }

        });
    </script>
</dom-module>
